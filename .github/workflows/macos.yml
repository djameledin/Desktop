name: macOS environment

on:
  workflow_dispatch:

jobs:
  setup-macos:
    runs-on: macos-latest
    timeout-minutes: 999999

    steps:
      - name: Update macOS
        run: |
          echo "Updating system..."
          softwareupdate -ia
          echo "System updated successfully"

      - name: Install Homebrew
        run: |
          echo "Installing Homebrew..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
          eval "$(/opt/homebrew/bin/brew shellenv)"
          echo "Homebrew installed"

      - name: Install Brave Browser
        run: |
          echo "Installing Brave Browser..."
          brew install --cask brave-browser
          echo "Brave installed"

      - name: Install Tailscale
        run: |
          echo "Installing Tailscale..."
          brew install --cask tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
          TAILSCALE_IP=$(tailscale ip -4 | tr -d '\r\n')
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "Tailscale Connected to $TAILSCALE_IP"

      - name: Enable Remote Management (VNC)
        run: |
          echo "Enabling VNC access..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -users $USER -privs -all -restart -agent -menu
          # Set VNC password
          echo "mypassword" | vncpasswd -f > /tmp/.vncpass
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true
          sudo chmod 600 /tmp/.vncpass
          echo "VNC Enabled with password: mypassword"

      - name: Install Microsoft Remote Desktop (RDP)
        run: |
          echo "Installing Microsoft Remote Desktop..."
          brew install --cask microsoft-remote-desktop
          echo "RDP client installed"

      - name: Keep Session Alive
        run: |
          echo "Keeping session alive..."
          while true; do
            echo "[ $(date) ] macOS session active..."
            sleep 300
          done
