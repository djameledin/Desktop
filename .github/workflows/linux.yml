name: Linux environment

on:
  workflow_dispatch:

jobs:
  linux-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create user
        run: |
          # create user if not exists
          if ! id -u user >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash user
          fi

          # generate a random password (alphanumeric, 12 chars)
          PASS=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 12 || openssl rand -base64 12)
          echo "user:$PASS" | sudo chpasswd

          # export to subsequent steps
          echo "RDP_USER=user" >> $GITHUB_ENV
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            meson \
            ninja-build \
            pkg-config \
            git \
            gettext \
            libwayland-dev \
            libxcb1-dev \
            libxcb-ewmh-dev \
            libxkbcommon-dev \
            libseat-dev \
            libwlroots-dev \
            wayland-protocols \
            network-manager \
            tailscale \
            cage || true

      - name: Install or build Hyprland
        run: |
          # try apt first (may not be available on ubuntu-latest)
          if ! command -v Hyprland >/dev/null 2>&1 && ! command -v hyprland >/dev/null 2>&1; then
            # build from upstream (meson + ninja preferred)
            TMPDIR=$(mktemp -d)
            git clone --depth 1 https://github.com/hyprwm/Hyprland.git "$TMPDIR/Hyprland"
            cd "$TMPDIR/Hyprland" || exit 1

            # some Hyprland versions use meson; attempt meson build then fallback to make
            if command -v meson >/dev/null 2>&1; then
              meson setup build
              meson compile -C build
              sudo meson install -C build || true
            elif [ -f Makefile ]; then
              sudo make -j"$(nproc)" || true
              sudo cp ./build/Hyprland /usr/bin/ || true
            fi

            # cleanup
            rm -rf "$TMPDIR"
          else
            echo "Hyprland is already installed."
          fi

      - name: Fix Wi-Fi issue (NetworkManager fallback)
        run: |
          # disable systemd-networkd if present and enable NetworkManager
          sudo systemctl disable --now systemd-networkd.service || true
          sudo systemctl enable --now NetworkManager.service || true

          # if nmcli exists, turn wifi off (useful in runners without wifi)
          if command -v nmcli >/dev/null 2>&1; then
            nmcli radio wifi off || true
          fi

          echo "NetworkManager enabled. If no Wi-Fi hardware detected, use Ethernet/Tailscale."

      - name: Login to Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if [ -z "${TAILSCALE_AUTH_KEY}" ]; then
            echo "No TAILSCALE_AUTH_KEY provided — skipping tailscale up."
          else
            sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="ubuntu-hyprland-${GITHUB_RUN_ID}" || true
            # try to get an IPv4 Tailscale address (may need a moment)
            IP=""
            for i in {1..10}; do
              IP=$(tailscale ip -4 2>/dev/null || echo "")
              if [ -n "$IP" ]; then break; fi
              sleep 1
            done
            echo "TAILSCALE_IP=${IP}" >> $GITHUB_ENV
            echo "Tailscale IP: ${IP}"
          fi

      - name: Start Hyprland session (virtual display)
        run: |
          # start a headless virtual Wayland session using cage as a compositor wrapper for a single client
          # run as 'user' (non-root). Use nohup so that the process can persist in background.
          sudo -u user bash -lc '
            export WAYLAND_DISPLAY=wayland-1
            # create XDG_RUNTIME_DIR for the user if missing
            mkdir -p /run/user/$(id -u user)
            sudo chown user: /run/user/$(id -u user) || true
            nohup cage -- Hyprland > /home/user/hyprland.log 2>&1 & disown
          '
          echo "Hyprland start attempted (background). Log: /home/user/hyprland.log"

      - name: Keep alive (prevent job from exiting)
        run: |
          echo "Ubuntu + Hyprland ready!"
          echo " Username : $RDP_USER ; Password : $RDP_PASS"
          echo " Tailscale : $TAILSCALE_IP"
          # keep the job alive; output heartbeat every 5 minutes
          while true; do
            echo "[ $(date -u) ] Alive..."
            sleep 300
          done⅝
