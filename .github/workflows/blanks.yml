name: Linux environment

on:
  workflow_dispatch:

jobs:
  linux-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Create user
        run: |
          sudo useradd -m -s /bin/bash user
          PASS=$(tr -dc A-Za-z0-9 | head -c 12)
          echo "user:$PASS" | sudo chpasswd

          echo "RDP_USER=user" >> $GITHUB_ENV
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential \
            cmake \
            meson \
            ninja-build \
            pkg-config \
            libwayland-dev \
            libxcb1-dev \
            libxcb-ewmh-dev \
            libxkbcommon-dev \
            libseat-dev \
            libwlroots-dev \
            wlroots \
            wayland-protocols \
            network-manager \
            tailscale \
            cage

      - name: Install Hyprland
        run: |
          sudo apt install -y hyprland || true

          if ! command -v Hyprland > /dev/null; then
            git clone https://github.com/hyprwm/Hyprland.git
            cd Hyprland
            sudo make all
            sudo cp ./build/Hyprland /usr/bin/
          fi

      - name: Fix Wi-Fi issue (NetworkManager fallback)
        run: |
          sudo systemctl disable --now systemd-networkd || true
          sudo systemctl enable --now NetworkManager

          nmcli radio wifi off
          echo "No WiFi hardware detected, using Ethernet only."

      - name: Login to Tailscale
        run: |
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=ubuntu-hyprland-${GITHUB_RUN_ID}

          IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV
          echo "Tailscale IP: $IP"

      - name: Start Hyprland session (virtual display)
        run: |
          sudo -u user \
          WAYLAND_DISPLAY=wayland-1 \
          cage -- Hyprland &

          echo "Hyprland started in virtual session."

      - name: Keep alive
        run: |
          echo "Ubuntu + Hyprland ready!"
          echo " Username : $RDP_USER ; Password : $RDP_PASS"
          echo " Tailscale : $TAILSCALE_IP"

          while true; do
            echo "[ $(date) ] Alive..."
            sleep 300
          done
