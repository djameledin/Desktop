name: Linux environment

on:
  workflow_dispatch:

jobs:
  clean-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 999999

    steps:
      - name: Update System
        run: |
          echo "Updating system..."
          sudo apt-get update -y
          sudo apt-get upgrade -y
          echo "System updated successfully"

      - name: Install GNOME Desktop Minimal and xRDP
        run: |
          echo "Installing GNOME Desktop Minimal + xRDP..."
          sudo apt-get install -y ubuntu-desktop-minimal gnome-session gdm3 xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo ufw allow 3389/tcp || true
          echo "gnome-session" > ~/.xsession

          # Disable animations to speed up GNOME
          gsettings set org.gnome.desktop.interface enable-animations false

          # Remove heavy packages to free resources
          sudo apt-get remove --purge -y thunderbird libreoffice-* && sudo apt-get autoremove -y

          echo "Minimal GNOME Desktop & RDP installed"

      - name: Create Temporary RDP User
        run: |
          USER="user"
          PASSWORD="user"
          sudo useradd -m -s /bin/bash $USER
          echo "$USER:$PASSWORD" | sudo chpasswd
          echo "RDP User Created: Username=$USER ; Password=$PASSWORD"

      - name: Install & Start Tailscale
        run: |
          echo "Setting up Tailscale..."
          set -e

          sudo apt-get update
          sudo apt-get install -y curl gnupg apt-transport-https ca-certificates lsb-release

          DIST=$(lsb_release -cs)

          curl -fsSL "https://pkgs.tailscale.com/stable/ubuntu/${DIST}.noarmor.gpg" \
            | sudo gpg --dearmour -o /usr/share/keyrings/tailscale-archive-keyring.gpg

          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu ${DIST} main" \
            | sudo tee /etc/apt/sources.list.d/tailscale.list

          sudo apt-get update
          sudo apt-get install -y tailscale
          sudo systemctl enable --now tailscaled

          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-${{ github.run_id }} \
            || (sudo tailscale down || true; sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }})

          TAILSCALE_IP=$(sudo tailscale ip -4 | tr -d '\r\n')
          echo "TAILSCALE_IP=$TAILSCALE_IP"
          echo "Tailscale Connected to $TAILSCALE_IP"

      - name: Install & Run RustDesk
        run: |
          echo "Installing RustDesk..."

          RUSTDESK_URL=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/releases/latest \
            | grep "x86_64.AppImage" \
            | cut -d '"' -f 4)
          curl -Lo rustdesk.AppImage $RUSTDESK_URL
          chmod +x rustdesk.AppImage
          
          nohup ./rustdesk.AppImage &>/dev/null &
          sleep 5 

          RUSTDESK_ID=$(./rustdesk.AppImage --get-id || echo "ID not available yet")
          echo "RustDesk ID: $RUSTDESK_ID"
          echo "RustDesk is running"

      - name: Keep RDP Session Alive
        run: |
          echo "Keeping session alive..."
          while true; do
            echo "[ $(date) ] RDP Session Active..."
            sleep 300
          done
